<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/springsecurity6">

<head>
    <meta charset="UTF-8">
    <title>Il Mio Carrello - Antica Pizzeria Romana</title>
    <link rel="icon" th:href="@{/images/LogoPizzeria.jpg}" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-danger" sec:authorize="!isAuthenticated()">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img th:src="@{/images/LogoPizzeria.jpg}" alt="Antica Pizzeria Romana" class="logo-navbar me-2">
                <span class="fw-bold text-white">Antica Pizzeria Romana</span>
            </a>
            <div class="d-flex">
                <a class="btn btn-outline-light me-2" href="/login">Login</a>
                <a class="btn btn-warning" href="/register">Registrazione</a>
            </div>
        </div>
    </nav>

    <nav class="navbar navbar-expand-lg navbar-dark bg-danger" sec:authorize="isAuthenticated()">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/pizze_scontate">
                <img th:src="@{/images/LogoPizzeria.jpg}" alt="Antica Pizzeria Romana" class="logo-navbar me-2">
                <span class="fw-bold text-white">Antica Pizzeria Romana</span>
            </a>
            <div class="d-flex align-items-center">
                <div class="dropdown">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" id="dropdownUserAuthenticated" data-bs-toggle="dropdown" aria-expanded="false">
						<i class="bi bi-person-fill me-1"></i> Benvenuta/o
						<span th:if="${clienteAttuale != null}" th:text="${clienteAttuale.nome}"></span>
						<span th:if="${clienteAttuale == null && oauthUserDisplayName != null}" th:text="${oauthUserDisplayName}"></span>
						<span th:if="${clienteAttuale == null && oauthUserDisplayName == null && #authentication.getPrincipal() instanceof T(org.springframework.security.oauth2.core.user.OAuth2User)}"
						      th:text="${#authentication.getPrincipal().getAttribute('name')}"></span>
                        <span th:if="${clienteAttuale == null && oauthUserDisplayName == null && !(#authentication.getPrincipal() instanceof T(org.springframework.security.oauth2.core.user.OAuth2User)) && #authentication.name != null && #authentication.name != 'anonymousUser'}"
						      th:text="${#authentication.name}"></span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownUserAuthenticated">
                        <li><a class="dropdown-item" th:href="@{/logout}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        <h1 class="mb-4 display-5 text-danger">Il Tuo Carrello</h1>

        <div th:if="${successoCarrello}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successoCarrello}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${erroreCarrello}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${erroreCarrello}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${carrello == null or #lists.isEmpty(carrello.elementi)}">
            <div class="alert alert-info shadow-sm" role="alert">
                <h4 class="alert-heading">Il tuo carrello è vuoto!</h4>
                <p>Sembra che tu non abbia ancora aggiunto nessuna delizia al tuo carrello.</p>
                <hr>
                <p class="mb-0">
                    <a th:href="@{/pizze_scontate}" class="btn btn-lg btn-warning" sec:authorize="isAuthenticated()">
                        <i class="bi bi-eye-fill"></i> Vai alle Pizze in Promozione
                    </a>
                    <a th:href="@{/}" class="btn btn-lg btn-warning" sec:authorize="!isAuthenticated()">
                        <i class="bi bi-eye-fill"></i> Scopri le Nostre Pizze
                    </a>
                </p>
            </div>
        </div>

        <div th:if="${carrello != null and not #lists.isEmpty(carrello.elementi)}">
            <div class="table-responsive shadow-sm">
                <table class="table table-hover align-middle">
                    <thead class="table-danger">
                        <tr>
                            <th scope="col" style="width: 15%;">Prodotto</th>
                            <th scope="col">Dettagli</th>
                            <th scope="col" class="text-center" style="width: 15%;">Quantità</th>
                            <th scope="col" class="text-end" style="width: 15%;">Prezzo Unitario</th>
                            <th scope="col" class="text-end" style="width: 15%;">Subtotale</th>
                            <th scope="col" class="text-center" style="width: 10%;">Azione</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="elemento, iterStat : ${carrello.elementi}" class="align-middle">
                            <td>
                                <img th:if="${elemento.pizza.imageUrl != null}" th:src="@{${elemento.pizza.imageUrl}}"
                                     class="cart-item-img" alt="Immagine Pizza">
                                <img th:unless="${elemento.pizza.imageUrl != null}" th:src="@{/images/pizze/Default.jpg}"
                                     class="cart-item-img" alt="Immagine Default">
                            </td>
                            <td>
                                <strong th:text="${elemento.pizza.nome}">Nome Pizza</strong>
                                <div class="cart-item-details" th:if="${not #lists.isEmpty(elemento.ingredientiExtraSelezionati)}">
                                    Extra: <span th:text="${#strings.listJoin(elemento.ingredientiExtraSelezionati.![nome], ', ')}"></span>
                                </div>
                                <div class="cart-item-details" th:if="${#lists.isEmpty(elemento.ingredientiExtraSelezionati)}">
                                    Extra: Nessuno
                                </div>
                            </td>
                            <td class="text-center">
                                <form th:if="${not #lists.isEmpty(carrello.elementi)}"
                                      th:with="actionUrlUserAggiorna=@{/carrello/aggiorna/{elementoCarrelloId}(elementoCarrelloId=${elemento.id})},
                                                 actionUrlAnonAggiorna=@{/carrello/aggiorna-anon}"
                                      th:action="${(#authentication.principal != 'anonymousUser') ? actionUrlUserAggiorna : actionUrlAnonAggiorna}"
                                      method="post" class="d-inline-flex align-items-center">
                                    <input type="number" name="quantita" th:value="${elemento.quantita}" min="1" max="99" class="form-control form-control-sm quantity-input">
                                    <input th:if="${#authentication.principal == 'anonymousUser'}" type="hidden" name="itemIndex" th:value="${iterStat.index}" />
                                    <button type="submit" class="btn btn-outline-primary btn-sm ms-1" title="Aggiorna quantità">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                </form>
                                </td>
                            <td class="text-end" th:text="${#numbers.formatDecimal(elemento.prezzoUnitarioCalcolato, 1, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</td>
                            <td class="text-end fw-bold" th:text="${#numbers.formatDecimal(elemento.getPrezzoTotaleElemento(), 1, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</td>
                            <td class="text-center">
                                 <form th:if="${not #lists.isEmpty(carrello.elementi)}"
                                      th:with="actionUrlUserRimuovi=@{/carrello/rimuovi/{elementoCarrelloId}(elementoCarrelloId=${elemento.id})},
                                                 actionUrlAnonRimuovi=@{/carrello/rimuovi-anon}"
                                      th:action="${(#authentication.principal != 'anonymousUser') ? actionUrlUserRimuovi : actionUrlAnonRimuovi}"
                                       method="post">
                                    <input th:if="${#authentication.principal == 'anonymousUser'}" type="hidden" name="itemIndex" th:value="${iterStat.index}" />
                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Rimuovi dal carrello">
                                        <i class="bi bi-trash3"></i>
                                    </button>
                                </form>
                                </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="row mt-4 gy-3">
                <div class="col-md-6 col-lg-8 d-flex align-items-start action-buttons">
                    <a th:href="@{/}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left-circle"></i> Continua Shopping
                    </a>
                    <form th:action="@{/carrello/svuota}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Sei sicuro di voler svuotare il carrello?')">
                            <i class="bi bi-cart-x"></i> Svuota Carrello
                        </button>
                    </form>
                </div>
                <div class="col-md-6 col-lg-4 text-md-end">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h4 class="card-title text-danger">Riepilogo Ordine</h4>
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotale Articoli:</span>
                                <span th:text="${#numbers.formatDecimal(totaleCarrello, 1, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between cart-total-summary text-danger">
                                <span>TOTALE:</span>
                                <span th:text="${#numbers.formatDecimal(totaleCarrello, 1, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</span>
                            </div>
                            <div class="d-grid gap-2 mt-3">
                                <a href="#" class="btn btn-success btn-lg">
                                    <i class="bi bi-credit-card"></i> Procedi all'Ordine
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div>
        <a th:href="@{/carrello}" class="cart-icon-fixed">
            <i class="bi bi-cart-fill"></i>
        </a>
    </div>

    <footer class="bg-danger text-white py-3 mt-auto">
        <div class="container text-center">
            <h4>Contattaci</h4>
            <p>
                <span th:text="${pizzeria != null ? pizzeria.nome : 'Nome Pizzeria'}">Nome Pizzeria</span><br>
                Indirizzo: <span th:text="${pizzeria != null ? pizzeria.indirizzo : 'Via'}">Via</span>, <span th:text="${pizzeria != null ? pizzeria.citta : 'Città'}">Città</span><br>
                Telefono: <span th:text="${pizzeria != null ? pizzeria.telefono : 'Numero di Telefono'}">Numero di Telefono</span><br>
                Email: <span th:text="${pizzeria != null ? pizzeria.email : 'Email'}">Email</span>
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>	